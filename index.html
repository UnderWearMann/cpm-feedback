<script>
    document.getElementById('search-button').addEventListener('click', searchSheet);

    function searchSheet() {
        const searchQuery = document.getElementById('search-input').value;
        const sheetId = '1UfQ7K08zEB1Hs-cYddYt-BEc_R97rlQlsmG4a1xfQOk';
        const apiKey = 'AIzaSyAoyn0yXsOCFci5gxEe16ynXKWPyKSQHz0';
        const range = 'A:I';

        fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${range}?key=${apiKey}`)
            .then(response => response.json())
            .then(data => {
                if (data.values) {
                    const headers = ["Partner Name", "Account Name", "KYC Status", "Created Date", "Age", "Notes"];
                    const dataRows = data.values.slice(1);

                    const results = dataRows.filter(row => {
                        if (row[1]) {
                            return row[1].toLowerCase().includes(searchQuery.toLowerCase());
                        }
                    }).map(row => {
                        return {
                            id: row[0], // Store Column A (ID)
                            partnerName: row[1],
                            accountName: row[4],
                            kycStatus: row[6],
                            createdDate: row[7],
                            age: row[8],
                            notes: ""
                        };
                    });

                    displayResults(results, headers);
                } else {
                    document.getElementById('results').querySelector('tbody').innerHTML = `<tr><td colspan="${headers.length}">No data found.</td></tr>`;
                }
            })
            .catch(error => {
                console.error('Error fetching data:', error);
                document.getElementById('results').querySelector('tbody').innerHTML = '<tr><td colspan="4">Error fetching data.</td></tr>';
            });
    }

    function displayResults(results, headers) {
        const resultsTableHead = document.getElementById('results').querySelector('thead tr');
        const resultsTableBody = document.getElementById('results').querySelector('tbody');
        resultsTableHead.innerHTML = '';
        resultsTableBody.innerHTML = '';

        headers.forEach(header => {
            const newHeader = document.createElement('th');
            newHeader.textContent = header;
            resultsTableHead.appendChild(newHeader);
        });

        if (results.length === 0) {
            resultsTableBody.innerHTML = `<tr><td colspan="${headers.length}">No matching results found.</td></tr>`;
            return;
        }

        results.forEach(row => {
            const newRow = resultsTableBody.insertRow();
            let rowValues = [row.partnerName, row.accountName, row.kycStatus, row.createdDate, row.age, row.notes]
            rowValues.forEach((cell, index) => {
                const newCell = newRow.insertCell();
                if (index === headers.length - 1) {
                    const input = document.createElement("input");
                    input.type = "text";
                    input.className = "user-input";
                    input.dataset.accountName = row.accountName;
                    input.dataset.rowID = row.id; //store the row ID
                    newCell.appendChild(input);
                } else {
                    newCell.textContent = cell;
                }
            });
        });
    }

    document.getElementById('results').addEventListener('change', function (event) {
        if (event.target.classList.contains('user-input')) {
            const inputElement = event.target;
            const accountName = inputElement.dataset.accountName;
            const userInput = inputElement.value;
            const rowID = inputElement.dataset.rowID;
            sendDataToSheet(accountName, userInput, rowID);
        }
    });

    function sendDataToSheet(accountName, userInput, rowID) {
        const scriptURL = "https://script.google.com/macros/s/AKfycbz9xrkScAZh4y-5ujeY7q8LPEpYVn4XmG3Ha8iC4GwFuOZoue65ColPVLvKWkb5llcHCQ/exec";

        fetch(scriptURL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                "accountName": accountName,
                "userInput": userInput,
                "rowID": rowID,
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.result === "success") {
                    console.log("Data updated successfully!");
                } else {
                    console.error("Error updating data:", data.message);
                }
            })
            .catch(error => {
                console.error('Error sending data:', error);
            });
    }
</script>
